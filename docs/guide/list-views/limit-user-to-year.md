<rtl>

# قصر المستخدم على سنة مالية (Limit User To Year)

تتيح هذه الميزة تقييد وصول المستخدمين إلى السنوات المالية والفترات المحاسبية المحددة، مما يمنع المستخدمين من عرض أو إنشاء مستندات في سنوات مالية غير مصرح لهم بالعمل عليها.

## الوصول للشاشة

- **المسار بالعربية**: إدارة النظام > الصلاحيات > قصر المستخدم على سنة مالية
- **المسار بالإنجليزية**: Administration > Security > Limit User To Year

## نظرة عامة

تُستخدم شاشة "قصر المستخدم على سنة مالية" للتحكم في:

1. **تقييد المستندات**: منع المستخدمين من عرض أو إنشاء مستندات في سنوات مالية أو فترات محاسبية معينة
2. **تقييد التقارير**: تحديد أقل تاريخ يمكن للمستخدم استخدامه في التقارير

## التفاصيل (Details)

### حقول تقييد السنوات والفترات

| الحقل | الوصف |
|-------|-------|
| **تطبق على (Apply To)** | الجهة التي سيُطبق عليها التقييد: مستخدم، مجموعة مستخدمين، ملف صلاحيات، أو موظف |
| **نوع المستند (Document Type)** | نوع المستند المراد تقييده (اختياري) |
| **قائمة أنواع (Type List)** | قائمة أنواع مستندات مُعرّفة مسبقاً لتقييدها دفعة واحدة (اختياري) |
| **السنة المالية (Fiscal Year)** | السنة المالية المسموح للمستخدم بالعمل عليها |
| **الفترة المحاسبية (Fiscal Period)** | الفترة المحاسبية المسموح بها (اختياري - للتقييد الأكثر دقة) |

### سلوك تقييد السنوات والفترات

- إذا تركت حقلي "نوع المستند" و"قائمة أنواع" فارغين، سيُطبق التقييد على **جميع أنواع المستندات**
- يمكن إضافة عدة سطور لنفس الجهة للسماح بعدة سنوات مالية
- التقييد **تراكمي**: إذا كان للمستخدم تقييدات متعددة (عبر المستخدم مباشرة، مجموعته، ملف صلاحياته، أو الموظف)، فإن النظام يجمع كل السنوات المسموحة

## قصر مستخدم على تواريخ في التقارير (Limit User to Dates In Reports)

### حقول تقييد التواريخ

| الحقل | الوصف |
|-------|-------|
| **تطبق على (Apply To)** | الجهة التي سيُطبق عليها التقييد |
| **أقل تاريخ (Min Date)** | أقل تاريخ ثابت يمكن للمستخدم اختياره في التقارير |
| **أقل تاريخ بالأيام من اليوم الحالي (Min Date From Today)** | عدد الأيام قبل اليوم الحالي كحد أدنى للتاريخ (قيمة متحركة) |

### سلوك تقييد التواريخ

- إذا تم تحديد "أقل تاريخ بالأيام من اليوم الحالي"، فإنه يأخذ الأولوية ويتم حساب التاريخ ديناميكياً
- النظام يختار التاريخ الأحدث (الأكبر) من بين جميع التقييدات المطبقة على المستخدم

## كيف يعمل النظام

### 1. تقييد قوائم المستندات (List Views)

عند عرض قائمة مستندات (مثل قائمة الفواتير)، يقوم النظام تلقائياً بـ:

```
1. التحقق من نوع المستند
2. البحث عن تقييدات المستخدم الحالي (مباشرة أو عبر المجموعة/ملف الصلاحيات/الموظف)
3. إضافة فلتر تلقائي على السنة المالية و/أو الفترة المحاسبية
```

::: tip ملاحظة
المستخدم لن يرى المستندات في السنوات غير المسموحة له، حتى لو كان لديه صلاحية على نوع المستند نفسه.
:::

### 2. تقييد أسئلة التقارير (Report Questions)

عند تشغيل تقرير، يقوم النظام بـ:

- **حقول التاريخ**: تلقائياً تعديل تاريخ "من" ليكون أقل تاريخ مسموح
- **حقول السنة المالية**: تلقائياً اختيار أول سنة مسموحة إذا كانت القيمة المختارة غير مسموحة
- **حقول الفترة المحاسبية**: تلقائياً اختيار أول فترة مسموحة

::: warning تنبيه
حقول التاريخ التي تمثل "إلى تاريخ" (To Date) لا تتأثر بهذا التقييد - فقط حقول "من تاريخ" (From Date).
:::

## أمثلة عملية

### مثال 1: تقييد محاسب على السنة الحالية فقط

1. أنشئ سجل جديد في شاشة "قصر المستخدم على سنة مالية"
2. في جدول التفاصيل:
   - **تطبق على**: اختر المستخدم المراد تقييده
   - **السنة المالية**: اختر السنة المالية الحالية (مثال: 2024)
3. احفظ السجل

**النتيجة**: المستخدم لن يستطيع رؤية مستندات السنوات السابقة في أي قائمة.

### مثال 2: تقييد مجموعة على آخر 90 يوم في التقارير

1. أنشئ سجل جديد
2. في جدول "قصر مستخدم على تواريخ في التقارير":
   - **تطبق على**: اختر مجموعة المستخدمين
   - **أقل تاريخ بالأيام من اليوم الحالي**: 90
3. احفظ السجل

**النتيجة**: أي تقرير يشغله مستخدم من هذه المجموعة، سيكون تاريخ "من" على الأقل 90 يوم قبل اليوم.

### مثال 3: تقييد على نوع مستند محدد

1. أنشئ سجل جديد
2. في جدول التفاصيل:
   - **تطبق على**: اختر المستخدم
   - **نوع المستند**: اختر "فاتورة مبيعات" مثلاً
   - **السنة المالية**: 2024
3. أضف سطر آخر:
   - **تطبق على**: نفس المستخدم
   - **نوع المستند**: اترك فارغاً (لباقي المستندات)
   - **السنة المالية**: 2023

**النتيجة**: المستخدم يرى فواتير المبيعات لسنة 2024 فقط، لكن باقي المستندات لسنة 2023.

## أولوية التطبيق

عندما يكون للمستخدم تقييدات متعددة، يتم التطبيق كالتالي:

1. تقييدات المستخدم المباشرة
2. تقييدات مجموعة المستخدمين
3. تقييدات ملف الصلاحيات
4. تقييدات الموظف المرتبط

::: info معلومة
جميع التقييدات **تُجمع** معاً - أي أن المستخدم يحصل على اتحاد (Union) جميع السنوات/الفترات المسموحة من كل المصادر.
:::

## ملاحظات فنية

### التخزين المؤقت (Caching)

- يتم تخزين بيانات التقييدات مؤقتاً في الذاكرة لتحسين الأداء
- يتم مسح التخزين المؤقت تلقائياً عند أي تغيير في سجلات "قصر المستخدم على سنة مالية"

### التأثير على الأداء

- التقييدات تُضاف كفلاتر SQL على قوائم المستندات
- لا يوجد تأثير ملحوظ على الأداء في الاستخدام العادي


</rtl>